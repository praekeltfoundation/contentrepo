# KB2 - Import/Export File Structure Reference

## Overview

This document details the CSV/XLSX column structure for all import/export file types in the content repository system. Each section includes required fields, data types, validation rules, and examples.

---

## 1. Content Pages

**Import Module:** home/import_content_pages.py
**Export Module:** home/export_content_pages.py

### Column Structure (31 columns)

#### Identification & Structure Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `structure` | string | Export only | Menu hierarchy display | "Menu 1", "Sub 1.1" |
| `message` | int | Export only | Message sequence number (1-indexed) | 1, 2, 3 |
| `page_id` | int | Export only | Database page ID | 12345 |
| `slug` | string | **YES** | Unique page identifier per locale | "welcome-page" |
| `parent` | string | No | Parent page title (empty for top-level) | "Main Menu" |
| `translation_tag` | string | No* | Translation key (*required for non-default locales) | "welcome_msg_001" |
| `language_code` | string | No | Locale language code | "en", "es", "fr" |

#### Web Channel Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `web_title` | string | **YES** | Page title (identifies page rows) | "Welcome to Our Service" |
| `web_subtitle` | string | No | Subtitle text | "Get started in 3 steps" |
| `web_body` | string | No | HTML content body | "&lt;p&gt;Welcome!&lt;/p&gt;" |

#### WhatsApp Channel Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `whatsapp_title` | string | No | WhatsApp channel title | "Welcome Message" |
| `whatsapp_body` | string | No | Message text (max 4096 chars, 1024 with media/buttons) | "Hi! Welcome to..." |
| `whatsapp_template_slug` | string | No | Reference to WhatsApp template | "welcome_template" |
| `example_values` | CSV list | No | Template variable values | "Helen, Good, Great" |
| `list_title` | string | No | List header (max 24 chars) | "Choose an option" |
| `list_items` | JSON | No | Array of list items (max 10) | See JSON format below |
| `footer` | string | No | Message footer (max 60 chars) | "Reply anytime" |
| `variation_title` | dict | No | Variation restriction (format: "type: value") | "gender: female" |
| `variation_body` | string | No | Variation-specific message text | "Hi sister! Welcome..." |
| `buttons` | JSON | No | Button array (max 3) | See JSON format below |
| `quick_replies` | CSV list | No | Quick reply options | "Yes, No, Maybe" |
| `triggers` | CSV list | No | Trigger keywords | "help, start, info" |

#### Other Channel Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `sms_title` | string | No | SMS channel title | "Welcome SMS" |
| `sms_body` | string | No | SMS text (max 459 chars) | "Welcome! Text HELP..." |
| `ussd_title` | string | No | USSD channel title | "Welcome USSD" |
| `ussd_body` | string | No | USSD text (max 160 chars) | "Welcome! 1.Info 2.Help" |
| `messenger_title` | string | No | Messenger channel title | "Welcome Messenger" |
| `messenger_body` | string | No | Messenger text (max 2000 chars) | "Welcome to..." |
| `viber_title` | string | No | Viber channel title | "Welcome Viber" |
| `viber_body` | string | No | Viber text (max 7000 chars) | "Welcome to..." |

#### Variations & Interactions

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `variation_title` | dict | No | Variation restriction (format: "type: value") | "gender: female" |
| `variation_body` | string | No | Variation-specific message text | "Hi sister! Welcome..." |
| `buttons` | JSON | No | Button array (max 3) | See JSON format below |
| `quick_replies` | CSV list | No | Quick reply options | "Yes, No, Maybe" |
| `triggers` | CSV list | No | Trigger keywords | "help, start, info" |

#### Metadata & Relations

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `tags` | CSV list | No | Tag list | "onboarding, welcome" |
| `related_pages` | CSV list | No | Related page slugs (same locale) | "faq, help, contact" |
| `image_link` | string | Export only | Image URL | "https://..." |
| `doc_link` | string | Export only | Document URL | "https://..." |
| `media_link` | string | Export only | Media URL (not imported) | "https://..." |

### Row Types

Content page imports support 4 row types:

1. **Page Index Row**: Has `web_title` but no body/messages (structure only)
2. **Content Page Row**: First row for page, has `web_title` + content
3. **Message Row**: Additional messages (no `web_title`, `message` > 1)
4. **Variation Row**: Has `variation_body` (variation of previous message)

### JSON Format Examples

**Buttons:**
```json
[
  {"type": "next_message", "title": "Continue"},
  {"type": "go_to_page", "title": "Learn More", "slug": "info-page"},
  {"type": "go_to_form", "title": "Take Quiz", "slug": "health-quiz"}
]
```

**List Items:**
```json
[
  {"type": "next_message", "title": "Option 1"},
  {"type": "go_to_page", "title": "Option 2", "slug": "page-slug"}
]
```

### CSV List Format

Comma-separated, quoted if containing commas:
```
"Item 1, with comma",Item 2,Item 3
```

### Validation Rules

- **Button titles**: Max 20 characters
- **List titles**: Max 24 characters
- **Max buttons**: 3 per message
- **Max list items**: 10 per message
- **Parent pages**: Must have unique title+locale+slug combination
- **Cannot change parent**: During import (use UI instead)
- **Related pages**: Must exist in same locale
- **WhatsApp body**: 4096 chars max, 1024 with media/buttons

### Example CSV Rows

```csv
slug,parent,web_title,whatsapp_body,buttons,language_code
"welcome",,Welcome Page,"Hi! Choose an option:","[{""type"":""next_message"",""title"":""Continue""}]","en"
"help","Welcome Page","Help Center","How can we help?","[{""type"":""go_to_page"",""title"":""FAQ"",""slug"":""faq""}]","en"
```

---

## 2. Ordered Content Sets

**Import Module:** home/import_ordered_content_sets.py
**Export Module:** home/export_ordered_sets.py

### Column Structure (9 columns)

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `name` | string | **YES** | Display name | "Weekly Health Tips" |
| `slug` | string | **YES** | Unique identifier | "weekly-health-tips" |
| `locale` | string | **YES** | Language code | "en" |
| `profile_field` | CSV list | No | Profile restrictions (format: "field:value") | "gender:female, age:18-24" |
| `page_slugs` | CSV list | **YES** | Content page slug list | "tip-1,tip-2,tip-3" |
| `time` | CSV list | No* | Time values (blank or "-" for optional) | "0,7,14" |
| `unit` | CSV list | No* | Time units (blank or "-" for optional) | "days,days,days" |
| `before_or_after` | CSV list | No* | Timing direction | "after,after,after" |
| `contact_field` | CSV list | No | Contact field names | "signup_date,,,," |

### Field Requirements

**List Length Matching:**

All CSV list fields must contain the same number of values as there are page slugs. Two options:

1. **Explicit values** - Provide a value for each page:
   ```csv
   page_slugs,time,unit,before_or_after,contact_field
   "page-1,page-2,page-3","0,7,14","days,days,days","after,after,after","signup_date,signup_date,signup_date"
   ```

2. **Optional timing** - Use single blank value `"-"` which auto-expands:
   ```csv
   page_slugs,time,unit,before_or_after,contact_field
   "page-1,page-2,page-3","-","-","-","-"
   ```
   This creates 3 pages with no timing constraints.

**Invalid** (mismatched lengths):
```csv
"page-1,page-2,page-3","0,7","days","after","signup_date"  ‚ùå time has 2 values but page_slugs has 3
```

**Profile Field Format:**
```
"field1:value1, field2:value2"
```

**Time Units:**
- Valid values: "minutes", "hours", "days", "weeks", "months"

**Before/After:**
- Valid values: "before", "after"

### Example CSV

```csv
name,profile_field,page_slugs,time,unit,before_or_after,contact_field,slug,locale
"Weekly Tips","gender:female","tip-1,tip-2,tip-3","0,7,14","days,days,days","after,after,after","signup_date","weekly-tips","en"
"Simple Set",,"page-1,page-2","-","-","-","-","simple-set","en"
```

### Validation Rules

- All list fields must contain the same number of values or single blank value
- Page slugs must reference existing ContentPages in same locale
- Profile field format must be "field:value" pairs
- Time values must be numeric or blank/"-"
- Time units must be one of: "minutes", "hours", "days", "weeks", "months"

---

## 3. WhatsApp Templates

**Import Module:** home/import_whatsapp_templates.py
**Export Module:** home/export_whatsapp_templates.py

### Column Structure (10 columns)

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `slug` | string | **YES** | Unique template identifier per locale | "welcome_template" |
| `locale` | string | **YES** | Language code | "en" |
| `category` | string | **YES** | Template category | "MARKETING" or "UTILITY" |
| `message` | string | **YES** | Template text (max 1024 chars) | "Hi {{1}}! Welcome..." |
| `example_values` | CSV list | No | Example values for {{1}}, {{2}}, etc. | "Helen, Good, Great" |
| `buttons` | JSON | No | Button array (max 3) | See JSON format below |
| `image` | string | Export only | Image URL | "https://..." |
| `submission_name` | string | No | Submitted template name | "welcome_v1" |
| `submission_status` | string | No | Submission status | "SUBMITTED" |
| `submission_result` | string | No | Result message (max 4096 chars) | "Approved by WhatsApp" |

### Template Variables

Use numbered placeholders in message text:
```
"Hi {{1}}! Your {{2}} is {{3}}."
```

Provide matching example values:
```
"Helen, order, ready"
```

System validates variable count matches example values.

### Button Format

Same as Content Pages:
```json
[
  {"type": "next_message", "title": "Continue", "slug": ""},
  {"type": "go_to_page", "title": "More Info", "slug": "info-page"},
  {"type": "go_to_form", "title": "Survey", "slug": "survey-form"}
]
```

### Example CSV

```csv
slug,category,message,example_values,buttons,locale
"welcome_template","MARKETING","Hi {{1}}! Welcome to {{2}}.","Helen, Our Service","[{""type"":""next_message"",""title"":""Get Started""}]","en"
"reminder_template","UTILITY","Your appointment is {{1}}.","tomorrow at 2pm",,en
```

### Validation Rules

- **Category**: Must be "MARKETING" or "UTILITY"
- **Message**: Max 1024 characters
- **Buttons**: Max 3, must have non-empty title
- **Button slugs**: Required for `go_to_page` and `go_to_form` types
- **Duplicate slugs**: Rejected in same import file
- **Variables**: Must match example values count

---

## 4. Assessments (Forms/Quizzes)

**Import Module:** home/import_assessments.py
**Export Module:** home/export_assessments.py

### Column Structure (24 columns)

#### Assessment Header Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `title` | string | **YES** | Assessment title | "Health Quiz" |
| `slug` | string | **YES** | Unique assessment identifier per locale | "health-quiz" |
| `locale` | string | **YES** | Language code | "en" |
| `version` | string | No | Version number | "v1.0" |
| `tags` | CSV list | No | Tag list | "health, quiz" |
| `generic_error` | string | **YES** | Default error message | "Invalid input" |

#### Result Page Configuration

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `high_result_page` | string | No | Slug for high scores | "high-score-page" |
| `high_inflection` | float | No | High score threshold (percentage) | 0.8 |
| `medium_result_page` | string | No | Slug for medium scores | "medium-score-page" |
| `medium_inflection` | float | No | Medium score threshold (percentage) | 0.5 |
| `low_result_page` | string | No | Slug for low scores | "low-score-page" |
| `skip_threshold` | float | No | Skip threshold (default 0.0) | 0.3 |
| `skip_high_result_page` | string | No | Page for high skip count | "skip-page" |

#### Question Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `question_type` | string | **YES** | Question type | "categorical_question", "age_question", "multiselect_question" |
| `question` | string | **YES** | Question text | "How often do you exercise?" |
| `explainer` | string | No | Question explanation/help text | "Select the option that best describes you" |
| `error` | string | No | Custom error for this question | "Please select an option" |
| `question_semantic_id` | string | No | Semantic ID for question | "exercise_frequency" |

#### Answer Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `answers` | CSV list | **YES** | Answer option list | "Daily, Weekly, Never" |
| `scores` | CSV list | **YES** | Score list (must have same number of values as answers) | "3.0, 2.0, 1.0" |
| `answer_semantic_ids` | CSV list | No | Semantic IDs for answers | "daily, weekly, never" |
| `answer_responses` | CSV list | No | Response messages for each answer | "Great!, Good, Try harder" |

#### Numeric Question Fields

| Column | Type | Required | Description | Example |
|--------|------|----------|-------------|---------|
| `min` | int | No | Minimum value (numeric questions) | 18 |
| `max` | int | No | Maximum value (numeric questions) | 100 |

### Multi-Question Format

Each assessment can have multiple questions. Repeat rows with:
- **Same**: `slug`, `locale`, `title` (identifies same assessment)
- **Different**: `question`, `answers`, `scores` per row

### Example CSV

```csv
title,question_type,slug,version,locale,generic_error,question,answers,scores,high_result_page,high_inflection
"Health Quiz","categorical_question","health-quiz","v1.0","en","Invalid input","How often exercise?","Daily,Weekly,Never","3.0,2.0,1.0","high-health",0.8
"Health Quiz","age_question","health-quiz","v1.0","en","Invalid input","Your age?","18-25,26-35,36+","1.0,1.0,1.0","high-health",0.8
"Health Quiz","multiselect_question","health-quiz","v1.0","en","Invalid input","Select all that apply","Option A,Option B,Option C","1.0,1.0,1.0","high-health",0.8
```

### Validation Rules

- **Headers**: Can use spaces/hyphens (converted to snake_case)
- **Equal lengths**: `answers`, `scores`, `answer_semantic_ids`, `answer_responses` must match
- **Inflection values**: Use "." not "," for decimals (e.g., "0.8" not "0,8")
- **Result pages**: Slugs must reference existing ContentPages in same locale
- **Scores**: Must be valid float values
- **Question types**: Must be valid enum values

---

## Shared Features Across All Import/Export Types

### File Format Support

**CSV:**
- UTF-8 encoding required
- Headers in first row
- Comma-separated values
- Quote strings containing commas/newlines

**XLSX:**
- Excel format (.xlsx)
- First worksheet used
- Headers in first row
- Reads formatted values

### Locale Handling

You can use either field:
- `locale` (display name): "English", "Spanish"
- `language_code`: "en", "es"

System converts display names to language codes automatically.

**Translation Tags:**
- Default locale pages: `translation_tag` optional
- Non-default locales: `translation_tag` **required**

### Import Modes

**Purge Mode** (default):
- Deletes all existing content before import
- Complete replacement
- Atomic transaction (all-or-nothing)

**Non-Purge Mode**:
- Updates existing records (matched by slug+locale)
- Creates new records
- Preserves unmatched existing records
- Atomic transaction (all-or-nothing)

### Progress Tracking

Import process reports progress via queue:
- 0%: Import started
- 1-99%: Processing rows
- 100%: Import complete

### Error Handling

**Row-Level Errors:**
- Error message includes row number
- Identifies specific problematic field
- Import fails atomically (no partial imports)

**Common Error Types:**
- Missing required fields
- Invalid data types
- Duplicate slugs
- Foreign key violations (referenced pages/forms don't exist)
- Length violations (character limits)
- Format violations (JSON, CSV lists)

### CSV List Parsing

System accepts multiple formats for CSV list fields:

**Standard comma-separated:**
```
Item1,Item2,Item3
```

**Quoted items with commas:**
```
"Item 1, with comma",Item 2,Item 3
```

**Mixed quoting:**
```
"Quoted item",Unquoted,Another unquoted
```

### JSON Field Parsing

JSON fields accept valid JSON:
```json
[{"key": "value"}, {"key": "value2"}]
```

**CSV escaping for JSON:**
```
"[{""key"":""value""},{""key"":""value2""}]"
```

### Export-Only Fields

These fields appear in exports but are ignored on import:
- `structure` (Content Pages)
- `message` (Content Pages)
- `page_id` (Content Pages)
- `image_link`, `doc_link`, `media_link` (Content Pages)
- `image` (WhatsApp Templates)

### Header Name Flexibility

Import accepts various header formats:
- Snake case: `web_title`
- Title case: `Web Title`
- Hyphenated: `web-title`

System normalizes to snake_case internally.

---

## Key Implementation Files

### Import/Export Modules
- Content Pages: home/import_content_pages.py | home/export_content_pages.py
- Ordered Sets: home/import_ordered_content_sets.py | home/export_ordered_sets.py
- WhatsApp Templates: home/import_whatsapp_templates.py | home/export_whatsapp_templates.py
- Assessments: home/import_assessments.py | home/export_assessments.py

### Helper Modules
- home/import_helpers.py - Shared parsing/validation
- home/content_import_export.py - Content entry points
- home/whatsapp_template_import_export.py - Template entry points
- home/assessment_import_export.py - Assessment entry points

### Models
- home/models.py - All model definitions with field constraints

### Test Data
- home/tests/import-export-data/ - 111+ test CSV/XLSX files

---

## Common Import Issues

See also: kb/1.md - Multiple Parents Error

### Issue: "Missing required field"
**Cause:** Required column missing from CSV/XLSX
**Fix:** Add missing column with header name matching one of: snake_case, Title Case, or hyphen-case

### Issue: "answers and scores must have the same length"
**Cause:** answers and scores contain different numbers of values in Assessment import
**Fix:** Ensure CSV lists have same number of values:
```csv
"Answer1,Answer2,Answer3","1.0,2.0,3.0"
```

### Issue: "Invalid inflection value"
**Cause:** Using comma instead of period in decimal, or non-numeric value
**Fix:** Use period for decimals: `0.8` not `0,8`

### Issue: "Referenced page does not exist"
**Cause:** Foreign key reference (parent, result_page, related_page) not found
**Fix:** Ensure referenced pages exist in same locale, or include them in import file

### Issue: "Duplicate slug"
**Cause:** Same slug appears multiple times in import file for same locale
**Fix:** Make slugs unique per locale, or combine into single multi-question assessment

### Issue: "Button title too long"
**Cause:** Button title exceeds 20 characters
**Fix:** Shorten button title to max 20 chars

### Issue: "Too many buttons"
**Cause:** More than 3 buttons defined
**Fix:** Reduce to maximum 3 buttons per message

### Issue: "Cannot change parent during import"
**Cause:** Existing page has different parent than import file specifies
**Fix:** Use CMS UI to change parent, or delete and recreate page

### Issue: "Invalid JSON format"
**Cause:** Malformed JSON in buttons/list_items field
**Fix:** Validate JSON syntax, ensure proper escaping in CSV:
```csv
"[{""type"":""next_message"",""title"":""Continue""}]"
```
